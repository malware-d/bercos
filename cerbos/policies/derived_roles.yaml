---
apiVersion: "api.cerbos.dev/v1"
derivedRoles:
  name: bank_roles
  definitions:
    - name: account_owner
      parentRoles: ["customer"]
      condition:
        match:
          all:
            of:
              - expr: request.resource.attr.customer_id == request.principal.attr.customer_id
              - expr: request.principal.attr.status == "active"
              - expr: request.principal.attr.email.endsWith("@mbbank.com") == false || request.principal.attr.role == "customer"

    - name: teller
      parentRoles: ["teller"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.status == "active"
              - expr: request.principal.attr.email.endsWith("@mbbank.com")
              - expr: request.principal.attr.branch_code != ""

    - name: branch_manager
      parentRoles: ["manager"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.status == "active"
              - expr: request.principal.attr.email.endsWith("@mbbank.com")
              - expr: request.principal.attr.approval_level >= 2
              - expr: request.principal.attr.branch_code != ""

    - name: compliance_officer
      parentRoles: ["compliance"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.status == "active"
              - expr: request.principal.attr.email.endsWith("@mbbank.com")
              - expr: request.principal.attr.department == "compliance"
              - expr: request.principal.attr.approval_level >= 3

    - name: security_admin
      parentRoles: ["security"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.status == "active"
              - expr: request.principal.attr.email.endsWith("@mbbank.com")
              - expr: request.principal.attr.department == "security"
              - expr: request.principal.attr.approval_level >= 4

    - name: system_admin
      parentRoles: ["admin"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.status == "active"
              - expr: request.principal.attr.email.endsWith("@mbbank.com")
              - expr: request.principal.attr.department == "it"
              - expr: request.principal.attr.approval_level >= 5

    - name: auditor
      parentRoles: ["auditor"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.status == "active"
              - expr: request.principal.attr.email.endsWith("@mbbank.com")
              - expr: request.principal.attr.department == "audit"
              - expr: request.principal.attr.read_only == true